<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="https://qaecy.github.io/demos/obc_1.4.21/dist/" />
    <title>Transparency issue</title>
    <script type="module" src="./src/main.ts"></script>
    <link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
/>

    <style>
      body{
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      qaecy-tile-streamer{
        width: 80vw;
        height: 80vh;
      }
      .btn-row{
        display: flex;
        position: absolute;
        top: 0px;
        left: 0px;
        right: 0px;
        gap: 10px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="btn-row">
      <button id="load-t">Load with transparency (fails)</button>
      <button id="load">Normal load</button>
    </div>
    <qaecy-tile-streamer id="viewer"></qaecy-tile-streamer>
    <script type="module">

      import duplex from '/src/defs/duplex';

      const viewer = document.getElementById("viewer");
      const loadTransparent = document.getElementById("load-t");
      const load = document.getElementById("load");

      viewer.setAttribute("bucketURL", `https://qaecy.github.io/sample-models/duplex/`);
      initEventListeners();

      async function loadModel(makeTransparent = false){
        await viewer.unloadAll();
        const copy = JSON.parse(JSON.stringify(duplex)); // Make a copy of the definition (so transparency not overriding)
        if(makeTransparent) makeAllTransparent(copy);
        await viewer.loadStream(copy);
      }

      function initEventListeners(){
        viewer.addEventListener('selection-change', (event) => {
          console.log('Selection changed:', event.detail);
        });
        load.addEventListener('click', (event) => {
          loadModel();
        });
        loadTransparent.addEventListener('click', (event) => {
          loadModel(true);
        });
      }

      // NB! Fails
      function makeAllTransparent(geometryData){
        geometryData.assets = geometryData.assets.map(item => {
          item.geometries = item.geometries.map(g => {
            g.color[3] = 0.001;
            return g;
          });
          return item;
        });
      }

    </script>
  </body>
</html>
